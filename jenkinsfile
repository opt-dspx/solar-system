pipeline {
    agent any

    environment {
        NODE_VERSION = "16"            // node.js versiyonunu ihtiyacınıza göre ayarlayın
        APP_DIR      = "."             // çalışma dizini
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Kaynak kod çekiliyor..."
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "Node modülleri yükleniyor..."
                sh "npm install"
            }
        }

        stage('Test') {
            steps {
                echo "Testler çalıştırılıyor..."
                sh "npm test"
            }
        }

        stage('Coverage') {
            steps {
                echo "Kod kapsamı ölçülüyor..."
                sh "npm run coverage"
            }
        }

        stage('Build / Lint') {
            steps {
                echo "Üretim için build veya lint işlemleri..."
                // İsterseniz lint komutu veya build adımı ekleyin
                // sh "npm run lint"
            }
        }

        stage('Docker Build & Push') {
            when {
                expression { return env.BRANCH_NAME == 'main' }
            }
            steps {
                echo "Docker imajı oluşturuluyor ve push ediliyor..."
                sh """
                   docker build -t myregistry/solar-system:${env.BUILD_NUMBER} .
                   docker push myregistry/solar-system:${env.BUILD_NUMBER}
                """
            }
        }

        stage('Deploy') {
            when {
                expression { return env.BRANCH_NAME == 'main' }
            }
            steps {
                echo "Üretim ortamına deploy ediliyor..."
                // Örneğin:
                // sh "ssh deploy@server 'docker pull myregistry/solar-system:${env.BUILD_NUMBER} && docker run --rm -d …'"
            }
        }
    }

    post {
        success {
            echo "Pipeline başarıyla tamamlandı."
            // Bildirim sistemi eklemek isterseniz burada yapabilirsiniz.
        }
        failure {
            echo "Pipeline başarısız oldu!"
            // İsterseniz hata bildirimi ekleyin (Slack, e-mail vb).
        }
        always {
            echo "Cleanup adımı (isteğe bağlı)."
            // Örneğin workspace temizleme gibi.
        }
    }
}

